{"version":3,"sources":["../index.js"],"names":["compose","debounce","delay","createStore","tempPropId","generateTempProp","funcs","length","arg","reduce","a","b","interval","func","timerId","clearTimeout","args","setTimeout","Promise","resolve","initialState","subscribers","reducerMap","reducers","actionQueue","patches","promises","currentState","applyPatches","nextState","forEach","prop","payload","Object","assign","notifyChange","slice","subscriber","patchState","promise","then","push","callReducer","copyQueue","customActions","next","actionData","action","Function","reducer","currentValue","reducerContext","dispatch","nextValue","subscribe","index","indexOf","splice","composeReducer","prev","state","undefined","actions","split","actionReducer","context","actionReducers","newReducers","entries","getState","types","success","result","failure"],"mappings":"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","file":"index.js","sourcesContent":["let tempPropId = 0;\r\nfunction generateTempProp() {\r\n  return `__prop__${tempPropId++}`;\r\n}\r\n\r\nexport function compose(...funcs) {\r\n  if (funcs.length === 0) {\r\n    return arg => arg;\r\n  }\r\n\r\n  if (funcs.length === 1) {\r\n    return funcs[0];\r\n  }\r\n\r\n  return funcs.reduce((a, b) => (...args) => a(b(...args)));\r\n}\r\n\r\nexport function debounce(interval, func) {\r\n  let timerId;\r\n  return function(...args) {\r\n    clearTimeout(timerId);\r\n    timerId = setTimeout(func, interval, ...args);\r\n  };\r\n}\r\n\r\nexport function delay(interval) {\r\n  return new Promise(resolve => setTimeout(resolve, interval));\r\n}\r\n\r\nexport function createStore(initialState = {}) {\r\n  const subscribers = [];\r\n  const reducerMap = {};\r\n  const reducers = [];\r\n  const actionQueue = [];\r\n  const patches = [];\r\n  const promises = {};\r\n  let currentState = initialState;\r\n\r\n  const applyPatches = debounce(0, function applyPatches() {\r\n    let nextState = currentState;\r\n    patches.forEach(({ prop, payload }) => {\r\n      if (nextState[prop] !== payload) {\r\n        nextState = Object.assign({}, nextState, {\r\n          [prop]: payload\r\n        });\r\n      }\r\n    });\r\n\r\n    if (nextState !== currentState) {\r\n      currentState = nextState;\r\n      notifyChange();\r\n    }\r\n  });\r\n\r\n  function notifyChange() {\r\n    subscribers.slice().forEach(subscriber => subscriber(currentState));\r\n  }\r\n\r\n  function patchState(prop, promise) {\r\n    promises[prop] = promise;\r\n    promise.then(payload => {\r\n      // dont apply patch if this promise is not latest\r\n      if (promises[prop] !== promise) return;\r\n      patches.push({ prop, payload });\r\n      applyPatches();\r\n    });\r\n  }\r\n\r\n  const callReducer = debounce(0, function callReducer() {\r\n    let nextState = currentState;\r\n    const copyQueue = actionQueue.slice();\r\n    const customActions = [];\r\n    actionQueue.length = 0;\r\n    copyQueue.forEach(actionData => {\r\n      function next(actionData) {\r\n        const { action, payload } = actionData;\r\n\r\n        if (action instanceof Function) {\r\n          customActions.push({ action, payload });\r\n          return;\r\n        }\r\n\r\n        reducers.forEach(([prop, reducer]) => {\r\n          const currentValue = nextState[prop];\r\n          const reducerContext = {\r\n            action,\r\n            payload,\r\n            dispatch(...args) {\r\n              dispatch(...args);\r\n              return currentValue;\r\n            }\r\n          };\r\n          const nextValue = reducer(currentValue, reducerContext);\r\n          if (nextValue !== currentValue) {\r\n            if (nextValue && nextValue.then) {\r\n              patchState(prop, nextValue);\r\n            } else {\r\n              nextState = Object.assign({}, nextState, {\r\n                [prop]: nextValue\r\n              });\r\n            }\r\n          }\r\n        });\r\n      }\r\n      next(actionData);\r\n    });\r\n\r\n    if (nextState !== currentState) {\r\n      currentState = nextState;\r\n      notifyChange();\r\n    }\r\n\r\n    customActions.forEach(({ action, payload }) => {\r\n      action(currentState, payload, dispatch);\r\n    });\r\n  });\r\n\r\n  function subscribe(subscriber) {\r\n    subscribers.push(subscriber);\r\n    return () => {\r\n      const index = subscribers.indexOf(subscriber);\r\n      if (index !== -1) {\r\n        subscribers.splice(index, 1);\r\n      }\r\n    };\r\n  }\r\n\r\n  function composeReducer(prop, reducer) {\r\n    if (prop in reducerMap) {\r\n      const prev = reducerMap[prop];\r\n      reducerMap[prop] = function(...args) {\r\n        const state = prev(...args);\r\n        return reducer(state, args.slice(1));\r\n      };\r\n    } else {\r\n      reducerMap[prop] = reducer;\r\n    }\r\n  }\r\n\r\n  function reducer(...args) {\r\n    if (args[0] === null || args[0] === undefined) {\r\n      args[0] = generateTempProp();\r\n    }\r\n    if (typeof args[0] === 'string') {\r\n      // reducer(prop, reducer:any)\r\n      // reducer(prop, action, reducer)\r\n\r\n      const prop = args[0];\r\n      if (typeof args[1] === 'string') {\r\n        // reducer(prop, action, reducer)\r\n        const actions = args[1].split(/\\s+/);\r\n        const actionReducer = args[2];\r\n        composeReducer(prop, (state, context) => {\r\n          if (actions.indexOf(context.action) !== -1) {\r\n            return actionReducer(context, state);\r\n          }\r\n          return state;\r\n        });\r\n      } else {\r\n        // reducer(prop, reducer:Function)\r\n        // reducer(prop, reducer:Object)\r\n        if (args[1] instanceof Function) {\r\n          // reducer(prop, reducer:Function)\r\n          const reducer = args[1];\r\n          composeReducer(\r\n            prop,\r\n            reducer instanceof Function ? reducer : () => reducer\r\n          );\r\n        } else {\r\n          // reducer(prop, reducer:Object)\r\n          // bind multiple action reducers\r\n          const actionReducers = args[1];\r\n          composeReducer(prop, (state, context) => {\r\n            const actionReducer = actionReducers[context.action];\r\n            if (actionReducer) {\r\n              return actionReducer instanceof Function\r\n                ? actionReducers[context.action](context, state)\r\n                : actionReducer;\r\n            }\r\n            return state;\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      const newReducers = args[0];\r\n      Object.entries(newReducers).forEach(([prop, reducer]) => {\r\n        composeReducer(prop, reducer);\r\n      });\r\n    }\r\n    reducers.length = 0;\r\n    reducers.push(...Object.entries(reducerMap));\r\n  }\r\n\r\n  function getState() {\r\n    return currentState;\r\n  }\r\n\r\n  function dispatch(action, payload, types) {\r\n    if (payload && payload.then) {\r\n      if (types) {\r\n        if (action !== undefined && action !== null) {\r\n          dispatch(action);\r\n        }\r\n\r\n        payload.then(\r\n          result => dispatch(types.success, result),\r\n          result => dispatch(types.failure, result)\r\n        );\r\n      } else {\r\n        payload.then(result => dispatch(action, result));\r\n      }\r\n\r\n      return;\r\n    }\r\n\r\n    actionQueue.push({ action, payload });\r\n    callReducer();\r\n  }\r\n\r\n  return {\r\n    dispatch,\r\n    getState,\r\n    reducer,\r\n    subscribe\r\n  };\r\n}\r\n\r\nexport default function() {}\r\n"]}